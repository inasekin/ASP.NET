### Пример декомпозиции монолита на микросервисы: Система управления воздушным движением (АТС)

---

#### 1. **Назначение системы**
Система управления воздушным движением (например, **Eurocontrol** или **FAA NextGen**) обеспечивает безопасное и эффективное перемещение самолётов в воздушном пространстве. Основные функции:
- Контроль взлётов и посадок.
- Маршрутизация воздушных судов.
- Управление задержками и перенаправлениями.
- Интеграция с метеорологическими службами.
- Отслеживание местоположения самолётов в реальном времени.

---

#### 2. **Бизнес-процесс: «Организация взлёта и посадки»**
Рассмотрим сценарий для аэропорта:
1. **Планирование рейса**: Диспетчер проверяет доступность взлётной полосы и воздушного коридора.
2. **Расчёт маршрута**: Определение оптимального пути с учётом погоды, загруженности и ограничений.
3. **Контроль движения**: Наблюдение за перемещением самолёта от взлёта до выхода на крейсерскую высоту.
4. **Экстренные ситуации**: Перенаправление рейсов при возникновении технических неполадок или штормов.
5. **Завершение рейса**: Управление посадкой и передача данных в наземные службы.

---

#### 3. **Микросервисы и их назначение**

1. **AuthService**
   - **Что делает**: Проверяет права доступа диспетчеров и экипажей.
   - **Пример**: Диспетчер не может разрешить взлёт, если его аккаунт не имеет статуса «Senior Controller».

2. **FlightService**
   - **Что делает**: Управляет данными рейсов (номер, статус, тип воздушного судна).
   - **Пример**: Создаёт новый рейс, обновляет его статус («взлёт разрешён», «посадка задержана»).

3. **RouteService**
   - **Что делает**: Рассчитывает маршруты, учитывая погоду, закрытые зоны и загруженность воздушного пространства.
   - **Пример**: Обходит зону турбулентности, предлагая альтернативный путь.

4. **WeatherService**
   - **Что делает**: Агрегирует данные о погоде (штормы, ветер, видимость).
   - **Пример**: Предупреждает о грозовом фронте на пути рейса.

5. **RadarService**
   - **Что делает**: Отслеживает местоположение самолётов в реальном времени.
   - **Пример**: Передаёт координаты рейса ABC123 каждые 5 секунд.

---

#### 4. **Взаимодействие сервисов при взлёте**

**Сценарий**: Диспетчер готовится разрешить взлёт рейса **NYC-PARIS**.

1. **Проверка прав диспетчера**:
   - **FlightService** → **AuthService** (синхронный REST-запрос).
   - **Данные**: `user_id`, `required_role: "takeoff_approve"`.
   - **Ожидает**: `{ "status": "approved", "role": "senior" }`.

2. **Получение метеоданных**:
   - **RouteService** → **WeatherService** (асинхронный запрос через RabbitMQ).
   - **Данные**: `flight_plan` (координаты маршрута).
   - **Ожидает**: `{ "wind_speed": 30 km/h, "turbulence_zones": ["x1,y1", "x2,y2"] }`.

3. **Расчёт маршрута**:
   - **FlightService** → **RouteService** (синхронный gRPC-запрос).
   - **Данные**: `current_location`, `destination`, `weather_data`.
   - **Ожидает**: `{ "optimal_route": [...], "estimated_time": "6h 15m" }`.

4. **Мониторинг воздушного пространства**:
   - **RadarService** → **FlightService** (вебсокеты, постоянная потоковая передача).
   - **Данные**: `current_position`, `speed`, `altitude`.

5. **Подтверждение взлёта**:
   - **FlightService** обновляет статус рейса на «Взлёт разрешён» и отправляет команду экипажу через **RadarService**.

---

#### 5. **Паттерн Strangler Fig для RouteService**

**Проблема**: В монолитной системе маршрутизация занимала 10–15 секунд из-за устаревшего алгоритма.

**Решение**:
1. **Шаг 1**: Выделили базовый расчёт маршрутов в микросервис **RouteService**, оставив интеграцию с погодой в монолите.
2. **Шаг 2**: Настроили API Gateway для разделения запросов: 50% шло в микросервис, 50% — в старый модуль. Сравнивали результаты.
3. **Шаг 3**: Перенесли в **RouteService** логику учёта погодных данных и закрытых зон.
4. **Шаг 4**: Полностью отключили старый модуль. Время расчёта сократилось до 2 секунд.

---

#### 6. **Почему это работает?**
- **Изоляция сбоев**: Если **WeatherService** упадёт, система продолжит работать с последними полученными данными.
- **Асинхронная связь** (RabbitMQ) между RouteService и WeatherService позволяет обрабатывать метеозапросы без блокировки основного потока.
- **Strangler Fig** позволил внедрить новый функционал без риска для безопасности полётов.

Такая архитектура превращает монолит в гибкую систему, где каждый сервис решает свою задачу, а диспетчеры могут принимать решения на основе актуальных данных.